<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../layout/layout.html">
<link rel="import" href="../fs-styles/fs-styles.html">
<link rel="import" href="../styles-wc/fs-button/fs-button.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../oak-i18n-behavior/oak-i18n-behavior.html">
<link rel="import" href="../oak-ajax-behavior/oak-ajax-behavior.html">
<!--
An element providing a solution to no problem in particular.

Example:

    <birch-gallery-view-selector></birch-gallery-view-selector>

@group Seed Elements
@element birch-gallery-view-selector
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="birch-gallery-view-selector">
  <style include='fs-styles'></style>
  <link rel="import" type="css" href="birch-gallery-view-selector.css">
  <template>
    <template is='dom-if' if="[[!readOnly]]">
      <iron-ajax
        bubbles
        id='newAlbum'
        url='[[ajaxbase]]/artifactmanager/albums'
        method='POST'
        headers='[[authHeaders]]'
        handle-as="json"
        body='[[_newAlbum]]'
        loading='{{_newAlbumLoading}}'
        on-response="_handleNewAlbum"></iron-ajax>
    </template>
    <!-- We need to have a tabindex of 0 here to allow this item to be user focusable -->
    <ul id='list' tabindex="0">
      <iron-selector id='routerSelector' selected='{{view}}' attr-for-selected='data-uid' selectable='.items-view'>
        <!-- My Memories Static Selector -->
        <li class='layout horizontal center justified items-view' data-uid='my-memories' on-dragover='_handleDrag' on-dragleave='_clearDrag' on-drop='_handleDrop' title$="[[i18n('memories_desc')]]">
          <div class="layout horizontal center">
            <i class='album-icon my-memories-icon'></i>
            <span data-test='selector-my-memories'>[[i18n('my_memories')]]</span>
            <span class='fs-badge' hidden$='[[_hideCount(hideCounts, view, "my-memories")]]'>[[count]]</span>
          </div>
        </li>
        <!-- My Archive Static Selector -->
        <li class='layout horizontal center justified items-view' data-uid='my-archive' on-dragover='_handleDrag' on-dragleave='_clearDrag' on-drop='_handleDrop' title$="[[i18n('archive_desc')]]">
          <div class="layout horizontal center">
            <i class='album-icon my-archive-icon'></i>
            <span>[[i18n('my_archive')]]</span>
            <span class='fs-badge' hidden$='[[_hideCount(hideCounts, view, "my-archive")]]'>[[_getCount(archiveCount, hideCounts, count)]]</span>
          </div>
        </li>
        <!-- My Favorites Static Selector -->
        <li class='layout horizontal center justified items-view' data-uid='my-favorites' on-dragover='_handleDrag' on-dragleave='_clearDrag' on-drop='_handleDrop' title$="[[i18n('favorites_desc)]]">
          <div class="layout horizontal center">
            <i class='album-icon my-favorites-icon'></i>
            <span>[[i18n('my_favorites')]]</span>
            <span class='fs-badge' hidden$='[[_hideCount(hideCounts, view, "my-favorites")]]'>[[_getCount(favoritesCount, hideCounts, count)]]</span>
          </div>
        </li>
        <!-- Recently Deleted Static Selector -->
        <template is="dom-if" if="[[showRecentlyDeleted]]">
          <li class='layout horizontal center justified items-view' data-uid='recently-deleted' on-dragover='_handleDrag' on-dragleave='_clearDrag' on-drop='_handleDrop' title$="[[i18n('deleted_desc)]]">
            <div class="layout horizontal center">
              <i class='album-icon recently-deleted-icon'></i>
              <span>[[i18n('recently_deleted')]]</span>
              <span class='fs-badge' hidden$='[[_hideCount(hideCounts, view, "recently-deleted")]]'>[[_getCount(deletedCount, hideCounts, count)]]</span>
            </div>
          </li>
        </template>
        <li class="li-padding " title$="[[i18n('albums')]]">
          <h5 class='albums-divider'>[[i18n('albums')]]</h5>
        </li>
        <template is='dom-if' if="[[!readOnly]]">
          <li id='newAlbumLink' class='layout li-padding horizontal center add-item-toggle' on-tap='_toggleAddAlbum' hidden$='[[_addingAlbum]]' title$="[[i18n('new_album')]]">
            <div class="layout horizontal center">
              <i class="album-icon add-folder-icon"></i>
              <span>[[i18n('new_album')]]</span>
            </div>
          </li>
        </template>
        <li id='newAlbumView' class='layout horizontal center' hidden$='[[!_addingAlbum]]'>
          <div class='add-album'>
            <button id='closeButton' class='close-button' is='fs-button' option='close' on-tap='_handleCancelNewAlbum'></button>
            <iron-a11y-keys target="[[_albumInput]]" keys="esc" on-keys-pressed="_toggleAddAlbum"></iron-a11y-keys>
            <iron-a11y-keys target="[[_albumInput]]" keys="enter" on-keys-pressed="_createNewAlbum"></iron-a11y-keys>
            <input id='titleInput' class='album-title-input' type="text" value='{{_newAlbum.name::input}}' maxlength$='[[_nameMaxLength]]'>
            <div class="layout horizontal center justified">
              <button id='saveButton' is='fs-button' option='recommended' on-tap='_createNewAlbum' disabled='[[!_newAlbum.name]]'>[[i18n('save')]]</button>
              <span>[[_charsRemaining(_newAlbum.name)]]</span>
            </div>
          </div>
        </li>
        <!-- Generated list of albums -->
        <template id="album-list" is='dom-repeat' items='{{albums}}' as='album' sort='_sortByName' filter='_isNotFavorite'>
          <li class='layout horizontal center justified items-view album-item' data-uid$='[[album.id]]' on-dragover='_handleDrag' on-dragleave='_clearDrag' on-drop='_handleDrop' title$="[[album.name]]">
            <div class='layout horizontal center'>
              <i class='album-icon folder-icon'></i>
              <span>[[album.name]]</span>
              <span class='fs-badge' hidden$='[[_hideCount(hideCounts, view, album.id)]]'>[[_getCount(album.artifactCount, hideCounts, count)]]</span>
            </div>
          </li>
        </template>
      </iron-selector>
    </ul>
  </template>
</dom-module>

<script>
(function() {
  Polymer({
    is: 'birch-gallery-view-selector',
    behaviors: [
      WCI18n(),
      OakI18nBehavior,
      OakAJAXBehavior
    ],
    properties: {
      // Private Props
      _addingAlbum: {
        type: Boolean,
        value: false
      },
      _albumInput: {
        type: Object,
        value: function() { return this.$.titleInput; }
      },
      _newAlbum: {
        type: Object,
        value: function() { return {}; }
      },
      _newAlbumLoading: {
        type: Boolean,
        value: false
      },
      _nameMaxLength: {
        type: Number,
        value: 200
      },

      // EXPORTED PROPS
      /**
       * The current selected view
       * @type {String}
       */
      view: {
        type: String,
        value:'my-memories',
        observer: '_notifyViewChanged',
        notify: true
      },

      // USER INPUTS
      /**
       * An array of albums to display for selection
       * @type {Array}
       */
      albums: {
        type: Array,
        notify: true,
        value: function() { return []; }
      },

      /**
       * The count to be used for the `My Memories` area
       *
       * _NOTE: If the `hideCounts` property is set to true
       * this property can be used to indicate the count for
       * all 3 of the main selection categories (My Memories,
       * My Archive, and My Favorites), without passing
       * `archiveCount` or `favoritesCount` (though they will
       * still work)_
       * @type {Number}
       */
      count: {
        type: Number,
        value: 0
      },

      /**
       * The displayed number of favorited artifacts available
       * @type {Number}
       */
      favoritesCount: {
        type: Number,
        value: null
      },

      /**
       * The displayed number of archived artifacts available
       * @type {Number}
       */
      archiveCount: {
        type: Number,
        value: null
      },

      /**
       * The displayed number of deleted artifacts available
       * @type {Number}
       */
      deletedCount: {
        type: Number,
        value: null
      },

      /**
       * If passed this will allow a user to, when focusing the list,
       * use the arrow keys to navigate through the available views
       * @type {Boolean}
       */
      handleKeypress: {
        type: Boolean,
        value: false
      },

      /**
       * If passed this will automatically focus the list so that
       * a user can immediately scroll through views on keypress.
       *
       * _NOTE: This is really only useful when `handleKeypress` is
       * set to true_
       * @type {Boolean}
       */
      autoFocus: {
        type: Boolean,
        value: false
      },

      /**
       * If passed this will disable the "Add Album" affordance
       * @type {Boolean}
       */
      readOnly: {
        type: Boolean,
        value: false
      },

      /**
       * If passed this will disable the displaying of counts
       * for everything except the active view.
       *
       * Additionally when set to true a user need only pass the
       * `count` property to display counts. If you pass `favoritesCount`
       * or `archiveCount` it will still work, this is simply
       * given as a convenience option
       * @type {Object}
       */
      hideCounts: {
        type: Boolean,
        value: false
      },

      showRecentlyDeleted: {
        type: Boolean,
        value: false
      }
    },
    ready: function() {
      this.listen(document, 'gallery-album-edit', '_renderAlbumList');
    },
    attached: function() {
      if (this.handleKeypress) {
        this.listen(this.$.list, 'focus', '_setupArrowListeners');
        this.listen(this.$.list, 'blur', '_removeArrowListners');
        if (this.autoFocus) {
          this.$.list.focus();
        }
      }
    },
    _charsRemaining: function(title) {
      if (!title) return this._nameMaxLength;
      return this._nameMaxLength - title.length;
    },
    _checkArrow: function(e) {
      var selector = this.$.routerSelector;
      if (e.keyCode == 38) {
        e.preventDefault();
        selector.selectPrevious();
      } else if (e.keyCode == 40) {
        e.preventDefault();
        selector.selectNext();
      }
      selector.selectedItem.scrollIntoView(false);
    },
    _clearDrag: function(e) {
      var target = e.currentTarget;
      target.classList.remove('dragging');
    },
    _createNewAlbum: function() {
      if (!this._newAlbum || !this._newAlbum.name || this.readOnly) return;
      this.$$('#newAlbum').generateRequest();
    },
    _getCount: function(count, hide, globalCount) {
      if (hide && typeof globalCount === 'number') return globalCount;
      return count;
    },
    _handleCancelNewAlbum: function() {
      this._toggleAddAlbum()
    },
    _handleNewAlbum: function(e) {
      if (!e || !e.detail || !e.detail.response) return;
      this.push('albums', e.detail.response);
      this.fire('gallery-router-new-album', e.detail.response);
      this._toggleAddAlbum();
    },
    _handleDrag: function(e) {
      if (this.readOnly || this.view === 'recently-deleted') return;
      e.preventDefault();
      var target = e.currentTarget;
      var collection = target.getAttribute('data-uid');
      if ((collection === 'my-archive' && this.view !== 'my-memories') || (collection === 'my-memories' && this.view !== 'my-archive'))  {
        e.dataTransfer.dropEffect = 'move';
      } else {
        target.classList.add('dragging');
      }
    },
    _handleDrop: function(e) {
      if (this.readOnly) return;
      e.preventDefault();
      var target = e.currentTarget;
      var collection = e.currentTarget.getAttribute('data-uid');
      // Don't move items to archive from albums or to my memories from anywhere but the archive
      if ((collection === 'my-archive' && this.view !== 'my-memories')
        || (collection === 'my-memories' && this.view !== 'my-archive')
        || (this.view === 'recently-deleted')) return;
      // Drop
      this._clearDrag(e);
      if (!e.dataTransfer.getData('text')) return;

      if (collection === 'my-favorites') {
        this.fire('gallery-execute-action', { 'actionType' : 'add_to_my_favorites' });
      } else if (collection === 'my-memories') {
        this.fire('gallery-execute-action', { 'actionType' : 'unarchive' });
      } else if (collection === 'my-archive') {
        this.fire('gallery-execute-action', { 'actionType' : 'archive' });
      } else if (collection === 'recently-deleted') {
        this.fire('gallery-execute-action', { 'actionType' : 'delete' });
      } else {
        // Tell gallery-data to add selected items to this album
        this.fire('gallery-execute-action', { 'actionType' : 'add_to_album', 'albumId' : collection });
      }
    },
    _hideCount: function(hide, currentView, targetView) {
      if (!hide) return false;
      return currentView != targetView;
    },
    _notifyViewChanged: function(value) {
      this.fire('gallery-view-changed', {
        view: value
      });
    },
    _setupArrowListeners: function() {
      this.listen(document, 'keydown', '_checkArrow');
    },
    _sortByName: function(a, b) {
      // If both values are undefined return 0;
      if (!a.name && !b.name) return 0;

      // If one of the values are undefined move
      // the existing value ahead of the non-existing
      if (!a.name || !b.name) return a.name ? -1 : 1;

      // Sort the values by name alphabetically
      var nameA = a.name.toLowerCase();
      var nameB = b.name.toLowerCase();
      if (nameA < nameB) return -1;
      if (nameA > nameB) return 1;
      return 0;
    },
    _renderAlbumList: function() {
      this.$['album-list'].render();
    },
    _isNotFavorite: function(album) {
      return album && !album.favorite;
    },
    _removeArrowListners: function() {
      this.unlisten(document, 'keydown', '_checkArrow');
    },
    _toggleAddAlbum: function() {
      this._newAlbum = {};
      this._addingAlbum = !this._addingAlbum;
      if (this._addingAlbum) {
        this.$.titleInput.focus();
      }
    },
  });
})();
</script>
